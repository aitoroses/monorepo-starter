#!/bin/bash

# Check variable
if [ -z $SEED_DIR ]
    then
        echo "Define a SEED_DIR Environment variable like:"
        echo "SEED_DIR=~/repositories/react-seed"
    else
        SEED_DIR=/Users/dbr/htdocs/bss/react-seed
        echo "trying with $SEED_DIR"
fi

echo "react-seed is in $SEED_DIR"

# Check directory
if [ ! -d $SEED_DIR ]
    then
        echo "directory doesn't exist."
        exit 0
fi

function seedVersion {
    echo $(node -p 'require("./package.json").bss.seedVersion')
}

# Get the current seed version
OLD_VERSION=$(seedVersion)

# Enter into seed and generate the patch
CURRENT_DIR=$(pwd)
cd $SEED_DIR

# Update git
git checkout -f develop
git pull

# Get the new version ( Can be specified by param )
if [ -z $1 ]
    then NEW_VERSION=$(seedVersion)
    else NEW_VERSION=$1
fi

# Generate the patch
echo
echo "Will create a patch between v$OLD_VERSION-v$NEW_VERSION"
git diff "v$OLD_VERSION" "v$NEW_VERSION" > $CURRENT_DIR/patch.diff

# Return to current dir and apply the patch
cd $CURRENT_DIR
1>/dev/null 2>/dev/null git apply --whitespace=fix --reject patch.diff
rm patch.diff
